<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab5 Temperature Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            brand: {
              50: '#ecfeff',
              100: '#cffafe',
              200: '#a5f3fc',
              300: '#67e8f9',
              400: '#22d3ee',
              500: '#06b6d4',
              600: '#0891b2',
              700: '#0e7490',
              800: '#155e75',
              900: '#164e63',
            },
          },
        },
      },
    };
  </script>
  <style>
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: #22d3ee; border-radius: 9999px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    body { scrollbar-color: #22d3ee #0f172a; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div id="root" class="max-w-6xl mx-auto p-6 space-y-6"></div>

  <script type="text/babel">
    const apiBase = '';
    const durations = {
      '1h': 60 * 60 * 1000,
      '1d': 24 * 60 * 60 * 1000,
      '30d': 30 * 24 * 60 * 60 * 1000,
    };
    const rangeLabels = {
      '1h': 'Last hour',
      '1d': 'Last day',
      '30d': 'Last 30 days',
    };

    const bucketOptions = [
      { value: 'raw', label: 'Measurements (raw)' },
      { value: 'hour', label: 'Hourly average' },
      { value: 'day', label: 'Daily average' },
    ];

    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

    function usePolling(fetcher, deps = [], interval = 1000) {
      const [data, setData] = React.useState(null);
      React.useEffect(() => {
        let active = true;
        const tick = async () => {
          try {
            const res = await fetcher();
            if (!active) return;
            setData(res);
          } catch (err) {
            console.error(err);
          }
        };
        tick();
        const id = setInterval(tick, interval);
        return () => { active = false; clearInterval(id); };
      }, deps);
      return data;
    }

    const formatDate = (ts) => new Date(ts).toLocaleString();

    function LineChart({ data, height = 260 }) {
      const padding = 24;
      const width = 900;
      const [hover, setHover] = React.useState(null);

      if (!data || data.length === 0) {
        return <div className="h-[260px] flex items-center justify-center text-slate-400">No data</div>;
      }

      const series = data.map(d => ({
        t: d.t ?? d.epoch_ms ?? d.time ?? d.ts ?? d.timestamp ?? (Array.isArray(d) ? d[0] : 0),
        v: d.v ?? d.value ?? d.val ?? d.temperature ?? (Array.isArray(d) ? d[1] : 0),
      })).filter(d => d.t);

      if (!series.length) {
        return <div className="h-[260px] flex items-center justify-center text-slate-400">No data</div>;
      }

      const times = series.map(s => s.t);
      const vals = series.map(s => s.v);
      const minT = Math.min(...times);
      const maxT = Math.max(...times);
      const minV = Math.min(...vals);
      const maxV = Math.max(...vals);
      const spanT = maxT - minT || 1;
      const spanV = maxV - minV || 1;

      const points = series.map(s => ({
        x: padding + ((s.t - minT) / spanT) * (width - padding * 2),
        y: height - padding - ((s.v - minV) / spanV) * (height - padding * 2),
        ...s,
      }));

      if (!points.length) {
        return <div className="h-[260px] flex items-center justify-center text-slate-400">No data</div>;
      }

      const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

      const handleMove = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        let best = null;
        let bestDist = Number.POSITIVE_INFINITY;
        points.forEach(p => {
          const d = Math.abs(p.x - x);
          if (d < bestDist) { bestDist = d; best = p; }
        });
        if (!best) return;
        const left = clamp(best.x, padding + 90, width - padding - 90);
        const top = clamp(best.y - 44, 8, height - 56);
        setHover({ ...best, left, top });
      };

      return (
        <div className="relative w-full">
          <svg
            viewBox={`0 0 ${width} ${height}`}
            className="w-full h-[260px] bg-slate-900/60 rounded-2xl border border-slate-800"
            onMouseMove={handleMove}
            onMouseLeave={() => setHover(null)}
          >
            <defs>
              <linearGradient id="lineFill" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stopColor="#22d3ee" stopOpacity="0.28" />
                <stop offset="100%" stopColor="#22d3ee" stopOpacity="0" />
              </linearGradient>
            </defs>
            <path d={pathD} fill="none" stroke="#22d3ee" strokeWidth="2.4" />
            <path d={`${pathD} L ${points[points.length - 1].x} ${height - padding} L ${points[0].x} ${height - padding} Z`} fill="url(#lineFill)" stroke="none" />
            {points.map((p, i) => (
              <circle key={i} cx={p.x} cy={p.y} r="3.2" fill="#22d3ee" opacity="0.85" />
            ))}
            {hover && <circle cx={hover.x} cy={hover.y} r="6" fill="#f97316" stroke="#0f172a" strokeWidth="2" />}
          </svg>
          {hover && (
            <div
              className="absolute px-3 py-2 text-xs bg-slate-900 border border-amber-400/60 text-slate-100 rounded-xl shadow-xl pointer-events-none"
              style={{ left: hover.left, top: hover.top }}
            >
              <div className="font-semibold">{hover.v.toFixed(2)} °C</div>
              <div className="text-slate-400">{formatDate(hover.t)}</div>
            </div>
          )}
        </div>
      );
    }

    function DataTable({ rows }) {
      if (!rows || rows.length === 0) {
        return <div className="text-slate-400">No data</div>;
      }
      return (
        <div className="overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/60">
          <div className="max-h-72 overflow-y-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-800/60 text-slate-200">
                <tr>
                  <th className="px-4 py-2 text-left font-semibold">Time</th>
                  <th className="px-4 py-2 text-right font-semibold">Value</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-800 text-slate-100">
                {rows.map((r, idx) => (
                  <tr key={idx} className="hover:bg-slate-800/40">
                    <td className="px-4 py-2 whitespace-nowrap">{formatDate(r.t)}</td>
                    <td className="px-4 py-2 text-right font-semibold">{(r.v ?? 0).toFixed(2)} °C</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function App() {
      const [bucket, setBucket] = React.useState('raw');
      const [range, setRange] = React.useState('1h');

      const current = usePolling(async () => {
        const res = await fetch(`${apiBase}/api/current`);
        return res.json();
      }, [], 1000);

      const stats = usePolling(async () => {
        const now = Date.now();
        const start = now - durations[range];
        const bucketParam = bucket === 'hour' ? 'hourly' : (bucket === 'day' ? 'daily' : 'raw');
        const url = `${apiBase}/api/stats?bucket=${bucketParam}&start=${start}&end=${now}`;
        const res = await fetch(url);
        return res.json();
      }, [bucket, range], 1000);

      const seriesRaw = Array.isArray(stats) ? stats : (stats?.data || stats?.samples || stats?.rows || []);
      const series = seriesRaw.map(s => {
        if (Array.isArray(s)) return { t: s[0], v: s[1] };
        return {
          t: s.epoch_ms ?? s.time ?? s.ts ?? s.timestamp ?? 0,
          v: s.value ?? s.val ?? s.temperature ?? 0,
        };
      }).filter(s => s.t);
      const tableRows = [...series].sort((a, b) => b.t - a.t);

      const currentText = current && current.value != null
        ? `${current.value.toFixed(2)} °C @ ${formatDate(current.epoch_ms || current.time || Date.now())}`
        : 'Loading...';

      return (
        <div className="space-y-4">
          <header className="flex flex-col gap-2">
            <p className="text-sm uppercase tracking-[0.25em] text-brand-300">Lab 5</p>
            <h1 className="text-3xl font-bold text-slate-50">Temperature Dashboard</h1>
            <p className="text-slate-400">Live sensor feed, aggregates, and quick viz</p>
          </header>

          <section className="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-lg shadow-brand-500/10">
            <div className="flex items-center justify-between gap-4 flex-wrap">
              <div>
                <p className="text-sm text-slate-400">Current</p>
                <p className="text-xl font-semibold text-brand-100">{currentText}</p>
              </div>
              <div className="flex items-center gap-3">
                <label className="text-sm text-slate-300">Bucket</label>
                <select
                  className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm"
                  value={bucket}
                  onChange={(e) => setBucket(e.target.value)}
                >
                  {bucketOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
              </div>
            </div>
          </section>

          <section className="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 shadow-lg shadow-brand-500/10 space-y-4">
            <div className="flex items-center gap-3 flex-wrap">
              <p className="text-sm text-slate-300">Range:</p>
              {Object.keys(rangeLabels).map(key => (
                <button
                  key={key}
                  onClick={() => setRange(key)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold border transition ${range === key ? 'bg-brand-500 text-slate-900 border-brand-500' : 'bg-slate-800 border-slate-700 text-slate-200 hover:border-brand-400/60'}`}
                >
                  {rangeLabels[key]}
                </button>
              ))}
            </div>

            <div className="space-y-3">
              <div className="flex items-center justify-between text-sm text-slate-300">
                <span className="font-semibold">Graph</span>
                <span className="text-slate-500">Auto-updates every second</span>
              </div>
              <LineChart data={series} />
            </div>

            <div className="space-y-3">
              <div className="flex items-center justify-between text-sm text-slate-300">
                <span className="font-semibold">Table</span>
                <span className="text-slate-500">Latest on top · Auto-updating</span>
              </div>
              <DataTable rows={tableRows} />
            </div>
          </section>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
